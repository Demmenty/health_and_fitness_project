{% extends 'personalpage/layout.html' %}
{% load static %}
{% load i18n %}

{% block title %}Дневник питания{% endblock %}

{% block content %}

<h1 class="text-center">Дневник питания</h1><br>

<!-- Кнопка соединения с FS -->
{% if user_not_connected %}
<a href="{% url 'fatsecretauth' %}"><button class='btn btn-info'>Привязать FatSecret</button></a><br><br>
<p>Ваш аккаунт на FatSecret должен быть подтвержденным.</p>
<p>Если не получается, попробуйте сначала войти в него на <a href="https://www.fatsecret.com" target="_blank">FatSecret</a></p>

{% else %}

<!-- Сводка за сегодня - авто -->
<h3>Сегодня</h3>
{% if food_entry %}

<table class="table table-bordered">
    <thead class="table-light">
        <tr>
            <th>Категория</th>
            <th>Продукт</th>
            <th class="text-center">Количество</th>
            <th class="text-center">Калории</th>
            <th class="text-center">Белки</th>
            <th class="text-center">Жиры</th>
            <th class="text-center">Углеводы</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            {% for category, count in count_meal_in_category.items %}
            {% if count > 0 %}
            <td rowspan="{{ count }}">{% translate category %}</td>
            {% endif %}
            {% for food in food_entry %}
            {% if food.meal == category %}
            <td>{{ food.food_entry_name }}</td>
            <td class="text-center">{{ food.norm_amount|default:"?" }} {{ food.serving.metric_serving_unit|default_if_none:"" }}</td>
            <td class="text-center">{{ food.calories }}</td>
            <td class="text-center">{{ food.protein }}</td>
            <td class="text-center">{{ food.fat }}</td>
            <td class="text-center">{{ food.carbohydrate }}</td> 
        </tr>
            {% endif %}
            {% endfor %}
            {% endfor %}
        <tr class="table-light">
            <th colspan="2" class="text-end">Всего:</th>
            <th class="text-center">{{ day_total.amount }} g/ml</th>
            <th class="text-center">{{ day_total.calories }}</th>
            <th class="text-center">{{ day_total.protein }}</th>
            <th class="text-center">{{ day_total.fat }}</th>
            <th class="text-center">{{ day_total.carbohydrate }}</th>
        </tr>
    </tbody>
</table>
<br>

<!-- если не посчитались какие-то продукты -->
{% if prods_without_info %}
<h3>Некоторые продукты не удалось нормально посчитать!</h3>
<p>Укажите их граммовку, пожалуйста</p>
<form method="POST" action="">
    {% csrf_token %}
    {% for prod, value in prods_without_info.items %}
    <p><b>Продукт:</b> {{ value.food_entry_name }}</p>
    <p>{{ value.serving_description }} = 
        <input type="hidden" value="{{ prod }}" name="food_id">
        <input type="hidden" value="{{ value.serving_id }}" name="serving_id">
        <input type="number" min="0" name="metric_serving_amount">
        <select name="metric_serving_unit">
            <option value="g">г</option>
            <option value="ml">мл</option>
        </select>
    </p><br>
    {% endfor %}
    <button type="submit" class="btn btn-info">Пересчитать</button>
</form>
<br>


{% endif %}




{% else %}
<p>Данные отсутствуют</p>
{% endif %}
<br>

<!-- Выбор сводки за другое число -->
<h5>Нужна сводка за другое число?</h5>
<form action = "{% url 'foodbydate' %}" method = "get">
    <input type="date" class="form-control text-center" name="date" id="input_briefdate">
    <button type="submit" class="btn btn-info" name="submit">Получить</button>
</form>
<br><br>

<!-- Сводка за текущий месяц -->
<h3>Текущий месяц</h3>
{% if food_entries_month %}
    <table class="table table-bordered text-center">
        <thead class="table-light">
            <tr>
                <th>Дата</th>
                <th>Калории</th>
                <th>Белки</th>
                <th>Жиры</th>
                <th>Углеводы</th>
            </tr>
        </thead>
        <tbody>
            {% for day in food_entries_month %}
            <tr>
                <td>{{ day.date_int|date:"j E" }}</td>
                <td>{{ day.calories }}</td>
                <td>{{ day.protein }}</td>
                <td>{{ day.fat }}</td>
                <td>{{ day.carbohydrate }}</td>
            </tr>
            {% endfor %}
            <tr class="table-light">
                <th>В среднем:</th>
                <th>{{ avg_calories }}</th>
                <th>{{ avg_protein }}</th>
                <th>{{ avg_fat }}</th>
                <th>{{ avg_carbo }}</th>
            </tr>
        </tbody>
    </table><br>

{% else %}
<p>Данные отсутствуют</p>
{% endif %}
<br><br>

<!-- Сводка за последний полный месяц -->


<!-- Выбор сводки за другой месяц-->
<h5>Нужна сводка за другой месяц?</h5>
<form action = "{% url 'foodbymonth' %}" method = "get">
    <input type="month" class="form-control text-center" name="month" id="input_briefmonth" value="{{ previous_month }}">
    <button type="submit" class="btn btn-info" name="submit">Получить</button>
</form>
<br><br>


<!-- Кнопка возврата -->
<a href="{% url 'personalpage' %}"><button class="btn btn-outline-primary" id="back_btn_questionary">Вернуться</button></a>


{% endif %}

{% endblock %}