{% extends 'personalpage/layout.html' %}
{% load static %}
{% load i18n %}

{% block title %}Антропометрия{% endblock %}

{% block content %}

{% if not metrics %}
    <p class="text-center">Данные измерений отсутствуют</p><br>

{% else %}
    {% if first_metrics %}
    <!-- таблица первых измерений -->
        <table class="table table-bordered caption-top text-center">
            <caption><h5>Первое измерение</h5></caption>
            <thead class="table-light">
                <tr>
                    <th>Дата</th>
                    <th>Плечо</th>
                    <th>Грудь</th>
                    <th>Талия</th>
                    <th>Живот</th>
                    <th>Ягодицы</th>
                    <th>Бедро</th>
                    <th>Голень</th>
                    <th>Фото</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>{{ first_metrics.date }}</td>
                    <td>{{ first_metrics.shoulder|default_if_none:"-" }}</td>
                    <td>{{ first_metrics.chest|default_if_none:"-" }}</td>
                    <td>{{ first_metrics.waist|default_if_none:"-" }}</td>
                    <td>{{ first_metrics.belly|default_if_none:"-" }}</td>
                    <td>{{ first_metrics.buttocks|default_if_none:"-" }}</td>
                    <td>{{ first_metrics.hip|default_if_none:"-" }}</td>
                    <td>{{ first_metrics.shin|default_if_none:"-" }}</td>
                    <td class="td_photo_btns">
                        {% if first_metrics.photo_1 %}
                        <img src="{% static 'personalpage/img/photo_pic.png' %}" title="показать фото" width="30"
                        class="show_photo_btn" id="btn_photo_1_first_metrics{{ forloop.counter }}">
                        <div class="container_photo hidden_element" id="photo_1_first_metrics{{ forloop.counter }}">
                            <button class="btn btn-outline-primary close_btn close_photo_btn" type="button" 
                            id="close_photo_1_first_metrics{{ forloop.counter }}" onclick="closePhoto(event)">&#10006</button>
                            <p class="text-center">{{ first_metrics.date }}</p>
                            <img src="{{ first_metrics.photo_1.url }}">
                        </div>
                        {% else %}
                        <img src="{% static 'personalpage/img/photo_pic.png' %}" title="фото отсутствует" width="30"
                        class="show_photo_btn luminosity" id="btn_photo_1_metrics{{ forloop.counter }}">
                        {% endif %}
                        {% if first_metrics.photo_2 %}
                        <img src="{% static 'personalpage/img/photo_pic.png' %}" title="показать фото" width="30"
                        class="show_photo_btn" id="btn_photo_2_first_metrics{{ forloop.counter }}">
                        <div class="container_photo hidden_element" id="photo_2_first_metrics{{ forloop.counter }}">
                            <button class="btn btn-outline-primary close_btn close_photo_btn" type="button" 
                            id="close_photo_2_first_metrics{{ forloop.counter }}" onclick="closePhoto(event)">&#10006</button>
                            <p class="text-center">{{ first_metrics.date }}</p>
                            <img src="{{ first_metrics.photo_2.url }}">
                        </div>
                        {% else %}
                        <img src="{% static 'personalpage/img/photo_pic.png' %}" title="фото отсутствует" width="30"
                        class="show_photo_btn luminosity" id="btn_photo_2_metrics{{ forloop.counter }}">
                        {% endif %}
                        {% if first_metrics.photo_3 %}
                        <img src="{% static 'personalpage/img/photo_pic.png' %}" title="показать фото" width="30"
                        class="show_photo_btn" id="btn_photo_3_first_metrics{{ forloop.counter }}">
                        <div class="container_photo hidden_element" id="photo_3_first_metrics{{ forloop.counter }}">
                            <button class="btn btn-outline-primary close_btn close_photo_btn" type="button" 
                            id="close_photo_3_first_metrics{{ forloop.counter }}" onclick="closePhoto(event)">&#10006</button>
                            <p class="text-center">{{ first_metrics.date }}</p>
                            <img src="{{ first_metrics.photo_3.url }}">
                        </div>
                        {% else %}
                        <img src="{% static 'personalpage/img/photo_pic.png' %}" title="фото отсутствует" width="30"
                        class="show_photo_btn luminosity" id="btn_photo_3_metrics{{ forloop.counter }}">
                        {% endif %}
                    </td>
                </tr>
            </tbody>
        </table><br>
    {% endif %}

    {% if show_all != 'True' %}
        <!-- таблица последних измерений -->
        <table class="table caption-top table-bordered text-center mb-0">
            <caption><h5>Последние измерения</h5></caption>
            <thead class="table-light">
                <tr>
                    <th>Дата</th>
                    <th>Плечо</th>
                    <th>Грудь</th>
                    <th>Талия</th>
                    <th>Живот</th>
                    <th>Ягодицы</th>
                    <th>Бедро</th>
                    <th>Голень</th>
                    <th>Фото</th>
                </tr>
            </thead>
            <tbody>
            {% for metrics in prev_metrics %}
                <tr>
                    <td>{{ metrics.date|default_if_none:"-" }}</td>
                    <td>{{ metrics.shoulder|default_if_none:"-" }}</td>
                    <td>{{ metrics.chest|default_if_none:"-" }}</td>
                    <td>{{ metrics.waist|default_if_none:"-" }}</td>
                    <td>{{ metrics.belly|default_if_none:"-" }}</td>
                    <td>{{ metrics.buttocks|default_if_none:"-" }}</td>
                    <td>{{ metrics.hip|default_if_none:"-" }}</td>
                    <td>{{ metrics.shin|default_if_none:"-" }}</td>
                    <td class="td_photo_btns">
                        {% if metrics.photo_1 %}
                        <img src="{% static 'personalpage/img/photo_pic.png' %}" title="показать фото" width="30"
                        class="show_photo_btn" value="" id="btn_photo_1_metrics{{ forloop.counter }}">
                        <div class="container_photo hidden_element" id="photo_1_metrics{{ forloop.counter }}">
                            <button class="btn btn-outline-primary close_btn close_photo_btn" type="button" 
                            id="close_photo_1_metrics{{ forloop.counter }}" onclick="closePhoto(event)">&#10006</button>
                            <p class="text-center">{{ metrics.date }}</p>
                            <img src="{{ metrics.photo_1.url }}">
                        </div>
                        {% else %}
                        <img src="{% static 'personalpage/img/photo_pic.png' %}" title="фото отсутствует" width="30"
                        class="show_photo_btn luminosity" value="" id="btn_photo_1_metrics{{ forloop.counter }}">
                        {% endif %}
                        {% if metrics.photo_2 %}
                        <img src="{% static 'personalpage/img/photo_pic.png' %}" title="показать фото" width="30"
                        class="show_photo_btn" value="" id="btn_photo_2_metrics{{ forloop.counter }}">
                        <div class="container_photo hidden_element" id="photo_2_metrics{{ forloop.counter }}">
                            <button class="btn btn-outline-primary close_btn close_photo_btn" type="button" 
                            id="close_photo_2_metrics{{ forloop.counter }}" onclick="closePhoto(event)">&#10006</button>
                            <p class="text-center">{{ metrics.date }}</p>
                            <img src="{{ metrics.photo_2.url }}">
                        </div>
                        {% else %}
                        <img src="{% static 'personalpage/img/photo_pic.png' %}" title="фото отсутствует" width="30"
                        class="show_photo_btn luminosity" value="" id="btn_photo_2_metrics{{ forloop.counter }}">
                        {% endif %}
                        {% if metrics.photo_3 %}
                        <img src="{% static 'personalpage/img/photo_pic.png' %}" title="показать фото" width="30"
                        class="show_photo_btn" value="" id="btn_photo_3_metrics{{ forloop.counter }}">
                        <div class="container_photo hidden_element" id="photo_3_metrics{{ forloop.counter }}">
                            <button class="btn btn-outline-primary close_btn close_photo_btn" type="button" 
                            id="close_photo_3_metrics{{ forloop.counter }}" onclick="closePhoto(event)">&#10006</button>
                            <p class="text-center">{{ metrics.date }}</p>
                            <img src="{{ metrics.photo_3.url }}">
                        </div>
                        {% else %}
                        <img src="{% static 'personalpage/img/photo_pic.png' %}" title="фото отсутствует" width="30"
                        class="show_photo_btn luminosity" value="" id="btn_photo_3_metrics{{ forloop.counter }}">
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
        
        {% if metrics.count > 3 %}
            <!-- кнопка открытия всех записей -->
            <form method="get" class="text-center">
                <input type="hidden" name="show_all" value="True">
                <input type="image" name="submit" id="btn_show_all" src="{% static 'personalpage/img/arrow_down_tab.svg' %}" style="width: 125px;" title="Все записи">
            </form>
        {% endif %}

    {% else %}
        <!-- таблица всех измерений -->
        <table class="table table-bordered caption-top text-center" id="all_anthropo_table">
            <caption><h5>Все измерения</h5></caption>
            <thead class="table-light">
                <tr>
                    <th>Дата</th>
                    <th>Плечо</th>
                    <th>Грудь</th>
                    <th>Талия</th>
                    <th>Живот</th>
                    <th>Ягодицы</th>
                    <th>Бедро</th>
                    <th>Голень</th>
                    <th>Фото</th>
                </tr>
            </thead>
            <tbody>
            {% for metric in metrics|dictsort:"date" %}
                <tr class="my-hover">
                    <td>{{ metric.date|default_if_none:"-" }}</td>
                    <td>{{ metric.shoulder|default_if_none:"-" }}</td>
                    <td>{{ metric.chest|default_if_none:"-" }}</td>
                    <td>{{ metric.waist|default_if_none:"-" }}</td>
                    <td>{{ metric.belly|default_if_none:"-" }}</td>
                    <td>{{ metric.buttocks|default_if_none:"-" }}</td>
                    <td>{{ metric.hip|default_if_none:"-" }}</td>
                    <td>{{ metric.shin|default_if_none:"-" }}</td>
                    <td class="td_photo_btns">
                        {% if metric.photo_1 %}
                        <img src="{% static 'personalpage/img/photo_pic.png' %}" title="показать фото" width="30"
                        class="show_photo_btn" value="" id="btn_photo_1_metric{{ forloop.counter }}">
                        <div class="container_photo hidden_element" id="photo_1_metric{{ forloop.counter }}">
                            <button class="btn btn-outline-primary close_btn close_photo_btn" type="button" 
                            id="close_photo_1_metric{{ forloop.counter }}" onclick="closePhoto(event)">&#10006</button>
                            <p class="text-center">{{ metric.date }}</p>
                            <img src="{{ metric.photo_1.url }}">
                        </div>
                        {% else %}
                        <img src="{% static 'personalpage/img/photo_pic.png' %}" title="фото отсутствует" width="30"
                        class="show_photo_btn luminosity" value="" id="btn_photo_1_metric{{ forloop.counter }}">
                        {% endif %}
                        {% if metric.photo_2 %}
                        <img src="{% static 'personalpage/img/photo_pic.png' %}" title="показать фото" width="30"
                        class="show_photo_btn" value="" id="btn_photo_2_metric{{ forloop.counter }}">
                        <div class="container_photo hidden_element" id="photo_2_metric{{ forloop.counter }}">
                            <button class="btn btn-outline-primary close_btn close_photo_btn" type="button" 
                            id="close_photo_2_metric{{ forloop.counter }}" onclick="closePhoto(event)">&#10006</button>
                            <p class="text-center">{{ metric.date }}</p>
                            <img src="{{ metric.photo_2.url }}">
                        </div>
                        {% else %}
                        <img src="{% static 'personalpage/img/photo_pic.png' %}" title="фото отсутствует" width="30"
                        class="show_photo_btn luminosity" value="" id="btn_photo_2_metric{{ forloop.counter }}">
                        {% endif %}
                        {% if metric.photo_3 %}
                        <img src="{% static 'personalpage/img/photo_pic.png' %}" title="показать фото" width="30"
                        class="show_photo_btn" value="" id="btn_photo_3_metric{{ forloop.counter }}">
                        <div class="container_photo hidden_element" id="photo_3_metric{{ forloop.counter }}">
                            <button class="btn btn-outline-primary close_btn close_photo_btn" type="button" 
                            id="close_photo_3_metric{{ forloop.counter }}" onclick="closePhoto(event)">&#10006</button>
                            <p class="text-center">{{ metric.date }}</p>
                            <img src="{{ metric.photo_3.url }}">
                        </div>
                        {% else %}
                        <img src="{% static 'personalpage/img/photo_pic.png' %}" title="фото отсутствует" width="30"
                        class="show_photo_btn luminosity" value="" id="btn_photo_3_metric{{ forloop.counter }}">
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% endif %}
        
{% endif %}

<!-- блок кнопок -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <!-- предоставление доступа к фото -->
    <form method="post" class="confirmquestion" id="photo_access_form">
        {% csrf_token %}
        {{ photoaccess_form }}
    </form>
    <!-- ошибки и статусы -->
    <p class="text-danger align-self-center text-center mb-0" id="photo_access_error"></p>
    <p class="text-danger text-center mb-0" id="status_addanthropo">{{ error }}</p>
    <!-- кнопка добавление записи -->
    <a href="#status_addanthropo">
        <button type="button" class="btn btn-outline-primary" id="btn_add_anthropo">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-plus-circle-dotted" viewBox="0 0 20 20">
                <path d="M8 0c-.176 0-.35.006-.523.017l.064.998a7.117 7.117 0 0 1 .918 0l.064-.998A8.113 8.113 0 0 0 8 0zM6.44.152c-.346.069-.684.16-1.012.27l.321.948c.287-.098.582-.177.884-.237L6.44.153zm4.132.271a7.946 7.946 0 0 0-1.011-.27l-.194.98c.302.06.597.14.884.237l.321-.947zm1.873.925a8 8 0 0 0-.906-.524l-.443.896c.275.136.54.29.793.459l.556-.831zM4.46.824c-.314.155-.616.33-.905.524l.556.83a7.07 7.07 0 0 1 .793-.458L4.46.824zM2.725 1.985c-.262.23-.51.478-.74.74l.752.66c.202-.23.418-.446.648-.648l-.66-.752zm11.29.74a8.058 8.058 0 0 0-.74-.74l-.66.752c.23.202.447.418.648.648l.752-.66zm1.161 1.735a7.98 7.98 0 0 0-.524-.905l-.83.556c.169.253.322.518.458.793l.896-.443zM1.348 3.555c-.194.289-.37.591-.524.906l.896.443c.136-.275.29-.54.459-.793l-.831-.556zM.423 5.428a7.945 7.945 0 0 0-.27 1.011l.98.194c.06-.302.14-.597.237-.884l-.947-.321zM15.848 6.44a7.943 7.943 0 0 0-.27-1.012l-.948.321c.098.287.177.582.237.884l.98-.194zM.017 7.477a8.113 8.113 0 0 0 0 1.046l.998-.064a7.117 7.117 0 0 1 0-.918l-.998-.064zM16 8a8.1 8.1 0 0 0-.017-.523l-.998.064a7.11 7.11 0 0 1 0 .918l.998.064A8.1 8.1 0 0 0 16 8zM.152 9.56c.069.346.16.684.27 1.012l.948-.321a6.944 6.944 0 0 1-.237-.884l-.98.194zm15.425 1.012c.112-.328.202-.666.27-1.011l-.98-.194c-.06.302-.14.597-.237.884l.947.321zM.824 11.54a8 8 0 0 0 .524.905l.83-.556a6.999 6.999 0 0 1-.458-.793l-.896.443zm13.828.905c.194-.289.37-.591.524-.906l-.896-.443c-.136.275-.29.54-.459.793l.831.556zm-12.667.83c.23.262.478.51.74.74l.66-.752a7.047 7.047 0 0 1-.648-.648l-.752.66zm11.29.74c.262-.23.51-.478.74-.74l-.752-.66c-.201.23-.418.447-.648.648l.66.752zm-1.735 1.161c.314-.155.616-.33.905-.524l-.556-.83a7.07 7.07 0 0 1-.793.458l.443.896zm-7.985-.524c.289.194.591.37.906.524l.443-.896a6.998 6.998 0 0 1-.793-.459l-.556.831zm1.873.925c.328.112.666.202 1.011.27l.194-.98a6.953 6.953 0 0 1-.884-.237l-.321.947zm4.132.271a7.944 7.944 0 0 0 1.012-.27l-.321-.948a6.954 6.954 0 0 1-.884.237l.194.98zm-2.083.135a8.1 8.1 0 0 0 1.046 0l-.064-.998a7.11 7.11 0 0 1-.918 0l-.064.998zM8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3v-3z"></path>
            </svg>
            Добавить запись
        </button>
    </a>
</div>

<!-- форма внесения новой записи -->
<!-- (Включение свойства enctype для формы обеспечивает правильное прикрепление загруженного файла к запросу) -->
<form method="post" action="" class="anthropometry_form hidden_element" id="add_anthropo_form" enctype="multipart/form-data">
    <h3 class="text-center">Внесение новых данных</h3><br>
    {% csrf_token %}
    <div class="form-group row">
        <label class="col-sm-3 col-form-label">{{ metrics_form.date.label }}</label>
        <div class="col-sm-9">{{ metrics_form.date }}</div>
    </div><br>
    <div class="form-group row">
        <label class="col-sm-3 col-form-label">{{ metrics_form.shoulder.label }}</label>
        <div class="col-sm-9">{{ metrics_form.shoulder }}</div>
    </div><br>
    <div class="form-group row">
        <label class="col-sm-3 col-form-label">{{ metrics_form.chest.label }}</label>
        <div class="col-sm-9">{{ metrics_form.chest }}</div>
    </div><br>
    <div class="form-group row">
        <label class="col-sm-3 col-form-label">{{ metrics_form.waist.label }}</label>
        <div class="col-sm-9">{{ metrics_form.waist }}</div>
    </div><br>
    <div class="form-group row">
        <label class="col-sm-3 col-form-label">{{ metrics_form.belly.label }}</label>
        <div class="col-sm-9">{{ metrics_form.belly }}</div>
    </div><br>
    <div class="form-group row">
        <label class="col-sm-3 col-form-label">{{ metrics_form.buttocks.label }}</label>
        <div class="col-sm-9">{{ metrics_form.buttocks }}</div>
    </div><br>
    <div class="form-group row">
        <label class="col-sm-3 col-form-label">{{ metrics_form.hip.label }}</label>
        <div class="col-sm-9">{{ metrics_form.hip }}</div>
    </div><br>
    <div class="form-group row">
        <label class="col-sm-3 col-form-label">{{ metrics_form.shin.label }}</label>
        <div class="col-sm-9">{{ metrics_form.shin }}</div>
    </div><br>
    <div class="form-group row">
        <label class="col-sm-12 form-label">{{ metrics_form.photo_1.label }}</label>
        <div class="col-sm-12">{{ metrics_form.photo_1 }}</div>
    </div><br>
    <div class="form-group row">
        <label class="col-sm-12 form-label">{{ metrics_form.photo_2.label }}</label>
        <div class="col-sm-12">{{ metrics_form.photo_2 }}</div>
    </div><br>
    <div class="form-group row">
        <label class="col-sm-12 form-label">{{ metrics_form.photo_3.label }}</label>
        <div class="col-sm-12">{{ metrics_form.photo_3 }}</div>
    </div>
    <!-- условие доступа -->
    {% if accessibility %}
    <p class="text-muted mt-2 mb-3"><span class="royal_blue">&#9658;</span><span id="photo_access_status"> эксперт имеет доступ к фотографиям</span></p>
    {% else %}
    <p class="text-muted mt-2 mb-3"><span class="royal_blue">&#9658;</span><span id="photo_access_status"> эксперт не имеет доступа к фотографиям</span></p>
    {% endif %}
    <button type="submit" class="btn btn-primary btn_rigth">Сохранить</button>
    <button type="button" class="btn btn-outline-primary" id="btn_hide_anthropo">Отмена</button>
</form>

<br>

<!-- переход к ежедневным показателям -->
<a href="{% url 'measurements' %}">
    <img src="{% static 'general/img/arrow_back_royalblue.svg' %}" class="hover_brigh" width="38" title="К измерениям">
</a>

<!-- обработка галочки о предоставлении доступа к фото -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
<script>
    $(document).ready(function () {
        // отслеживаем событие отправки формы
        $('#id_photo_access').change(function () {
            
            // уведомление о доступности фото
            photoAccessStatus = document.getElementById("photo_access_status");

            // создаем AJAX-вызов
            $.ajax({
                data: $('#photo_access_form').serialize(), // получаем данные формы
                type: $('#photo_access_form').attr('method'), // метод отправки запроса
                url: "{% url 'photoaccess_change' %}", // функция обработки
                
                // После успешного завершения запросов запускается одна из колбэк-функций success или error.
                success: function (response) {
                    if (response.accessible) {
                        photoAccessStatus.textContent = " эксперт имеет доступ к фотографиям";
                    }
                    else {
                        photoAccessStatus.textContent = " эксперт не имеет доступа к фотографиям";
                    }
                    },
                error: function (response) {
                    error = document.getElementById("photo_access_error");
                    error.textContent = "произошла ошибка!";
                    }
            });
            return false;
        });
    })    
</script>

<script src="{% static 'personalpage/js/anthropometry.js' %}"></script>
{% endblock %}