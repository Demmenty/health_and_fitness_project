{% extends 'personalpage/layout.html' %}
{% load static %}

{% block title %}Личный кабинет{% endblock %}

{% block content %}

<h2>Персональная страница клиента: {{ user.username }}</h2><br>

<!-- ссылка на анкету -->
{% if questionary %}
<h3>Ваша анкета</h3>
{% else %}
<h3>Пожалуйста, заполните анкету</h3>
{% endif %}
<a href="{% url 'questionary' %}"><button class="btn btn-primary">Анкета</button></a><br><br>

<!-- измерения за сегодня -->
{% if today_measure %}
    <div class="table-responsive today_measure_table" id="today_measure_table">
        <table class="table table-bordered caption-top table-fixed text-center">
            <caption><h3>Данные измерений за сегодня</h3></caption>
            <tr><th class="tablerow_name">Дата</th><td>{{ today_measure.date }}</td></tr>
            <tr><th class="tablerow_name">Самочувствие</th><td>{% if today_measure.feel %}{{ today_measure.feel }}/10{% else %}-{% endif %}</td></tr>
            <tr><th class="tablerow_name">Вес</th><td>{% if today_measure.weight %}{{ today_measure.weight }} кг{% else %}-{% endif %}</td></tr>
            <tr><th class="tablerow_name">Процент жира</th><td>{% if today_measure.fat %}{{ today_measure.fat }} %{% else %}-{% endif %}</td></tr>
            <tr><th class="tablerow_name">Пульс в покое</th><td>{% if today_measure.pulse %}{{ today_measure.pulse }} уд/мин{% else %}-{% endif %}</td></tr>
            {% if today_measure.pressure_upper and today_measure.pressure_lower %}<tr><th class="tablerow_name">Давление</th><td>{{ today_measure.pressure_upper }}/{{ today_measure.pressure_lower }}</td></tr>{% endif %}
            <tr><th class="tablerow_name">Калории</th><td>{{ today_measure.calories|default_if_none:"-" }}</td></tr>
            <tr><th class="tablerow_name">Белки</th><td>{{ today_measure.protein|default_if_none:"-" }}</td></tr>
            <tr><th class="tablerow_name">Жиры</th><td>{{ today_measure.fats|default_if_none:"-" }}</td></tr>
            <tr><th class="tablerow_name">Углеводы</th><td>{{ today_measure.carbohydrates|default_if_none:"-" }}</td></tr>
            {% if today_measure.comment %}<tr id="tr_today_comment">{% else %}<tr id="tr_today_comment" class="hidden_element">{% endif %}
                <th class="tablerow_name">Комментарий</th><td id="today_comment">{{ today_measure.comment }}</td></tr>
        </table>
        <p class="error_message">{{ error }}</p>
    </div><br>
    <a href="{% url 'addmeasure' %}"><button class='btn btn-primary'>Редактировать записи</button></a><br><br>
{% else %}
    <p>За сегодня измерений не сделано.</p><br>
    <p>Данные необходимо вносить каждый день!</p><br>
    <a href="{% url 'addmeasure' %}"><button class='btn btn-primary'>Добавить запись</button></a><br><br>
{% endif %}

<!-- дневник питания -->
<a href="{% url 'mealjournal' %}"><button class='btn btn-primary' data-bs-toggle="modal" data-bs-target="#load_cat">Дневник питания</button></a>

<!-- дневник антропометрии -->
<a href="{% url 'anthropometry' %}"><button class='btn btn-primary'>Антропометрия</button></a><br><br>
<br>



<!-- измерения за неделю-->
<table class="week_table table table-bordered caption-top align-middle text-center">
    <caption><h3>Данные измерений за неделю</h3></caption>
    <thead class="table-light">
        <tr>
            <th>Дата</th>
            <th>День</th>
            <th>Самочувствие</th>
            <th>Масса</th>
            <th>Жирность</th>
            <th>Пульс</th>
            {% if show_pressure %}
                <th>Давление</th>
            {% endif %}
            <th>Калории</th>
            <th>Белки</th>
            <th>Жиры</th>
            <th>Углеводы</th>
            <td class="borderless">&nbsp</td>
        </tr>
    </thead>
    <tbody>
        {% for day in week|dictsort:"date" %}
        <tr class="my-hover">
            <td>{{ day.date|date:"j b" }}</td>
            <td>{{ day.date|date:"D" }}</td>
            <td>{% if day.feel %}{{ day.feel }}/10{% endif %}</td>
            <td>{% if day.weight %}{{ day.weight }} кг{% endif %}</td>
            <td>{% if day.fat %}{{ day.fat }} %{% endif %}</td>
            <td>{{ day.pulse|default_if_none:"" }}</td>
            {% if show_pressure %}
                <td>{% if day.pressure_upper is not None and day.pressure_lower is not None %}
                        {{ day.pressure_upper }}/{{ day.pressure_lower }}
                    {% endif %}</td>
            {% endif%}
            <td>{{ day.calories|default_if_none:"" }}</td>
            <td>{{ day.protein|default_if_none:"" }}</td>
            <td>{{ day.fats|default_if_none:"" }}</td>
            <td>{{ day.carbohydrates|default_if_none:"" }}</td>
            <td class="borderless">
                <img src="{% static 'personalpage/img/comment_pic_24x20.png' %}" title="показать комментарий"
                {% if day.comment %}class="comment_btn noluminosity"{% else %}class="comment_btn luminosity"{% endif %}
                value="{{ day.date }}" id="comment_btn{{ forloop.counter }}">
            </td>
        </tr>
        {% endfor %}
        <tr class="table-light">
            <th colspan="2">В среднем:</th>
            <th>{{ avg_week.avg_feel|default:"" }}</th>
            <th>{{ avg_week.avg_weight|default:"" }}</th>
            <th>{{ avg_week.avg_fat|default:"" }}</th>
            <th>{{ avg_week.avg_pulse|default:"" }}</th>
            {% if show_pressure %}
                <th>{{ avg_week.avg_pressure|default:"" }}</th>
            {% endif%}
            <th>{{ avg_week.avg_calories|default:"" }}</th>
            <th>{{ avg_week.avg_protein|default:"" }}</th>
            <th>{{ avg_week.avg_fats|default:"" }}</th>
            <th>{{ avg_week.avg_carbohydrates|default:"" }}</th>
            <td class="borderless">&nbsp</td>
        </tr>
    </tbody>
</table>
<p class="text-muted"><span class="royal_blue">&#9658;</span> среднее КБЖУ считается без учета сегодняшнего дня</p><br>



<!-- всплывающие по кнопке комменты -->
{% for comment in week_comments_forms %}
<div class="container_commentform hidden_element" id="comment{{ forloop.counter }}">
    <form method="post" class="d-flex flex-column commentForm" id="commentForm{{ forloop.counter }}">
        {% csrf_token %}
        {{ comment.comment }}{{ comment.date }}
        <div class="d-flex justify-content-between align-items-center commentbtn_container">
            <button class="btn btn-outline-primary sm_square_btn" type="button" 
            id="close_comment_btn{{ forloop.counter }}" value="{{ comment.date.value }}"
            onclick="closeComment(event)">&#10006</button>
            <div id="comment{{ forloop.counter }}header" class="comment_header text-center">сохранено</div>
            <button class="btn btn-primary sm_square_btn" type="submit">&#10003</button>
        </div>
    </form>
</div>
{% endfor %}


<!-- сохранение комментария -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
<script>
    $(document).ready(function () {
        // отслеживаем событие отправки формы
        $('.commentForm').submit(function () {
            
            // ID формы
            formId = $(this).attr('id');
            // номер коммента
            commentNum = formId[11];
            // соответствующий коммент
            comment = $("#" + formId + " > #id_comment")[0];
            // соответствующая кнопка
            commentBtn = document.getElementById("comment_btn" + commentNum);
            // соответствующее поле для надписи о сохранении
            commentStatusField = document.getElementById("comment" + commentNum + "header");

            // создаем AJAX-вызов
            $.ajax({
                data: $(this).serialize(), // получаем данные формы
                type: $(this).attr('method'), // метод отправки запроса
                url: "{% url 'commentsave' %}", // функция обработки
                
                // После успешного завершения запросов запускается одна из колбэк-функций success или error.
                success: function (response) {
                    if (response.new_comment == '') {
                        // если новый коммент пуст - делаем его кнопку серой
                        commentBtn.classList.add('luminosity'); 
                        // меняем поле коммента в таблице за сегодня
                        if (document.getElementById("today_measure_table") && (commentNum == '7')) {
                            document.getElementById("tr_today_comment").classList.add('hidden_element');
                        }
                    }
                    else {
                        // если новый коммент не пуст - делаем его кнопку синей
                        commentBtn.classList.remove('luminosity');
                        // меняем поле коммента в таблице за сегодня
                        if (document.getElementById("today_measure_table") && (commentNum == '7')) {
                            document.getElementById("tr_today_comment").classList.remove('hidden_element');
                            document.getElementById("today_comment").textContent = response.new_comment;
                        }
                    }
                    // голубая подсветка коммента и статуса
                    comment.classList.add('comment_saved');
                    commentStatusField.textContent = 'сохранено';
                    commentStatusField.classList.add('comment_saved');
                    setTimeout(() => {
                        comment.classList.remove('comment_saved');
                        commentStatusField.classList.remove('comment_saved');
                    }, 1000);

                    },
                error: function (response) {
                    // красная подсветка коммента и статуса
                    comment.classList.add('comment_not_saved');
                    commentStatusField.textContent = 'не сохранено';
                    commentStatusField.classList.add('comment_not_saved');
                    setTimeout(() => {
                        comment.classList.remove('comment_not_saved');
                        commentStatusField.classList.remove('comment_not_saved');
                    }, 1000);
                    }
            });
            // return false в конце скрипта предотвращает отправку форм, останавливая перезагрузку страницы.
            return false;
        });
    })    
</script>

<br>

<!-- Статистика за произвольную дату -->
{% if selected_period %}
<table class="table table-bordered caption-top align-middle text-center">
    <caption><h3>Данные измерений за {{ selected_period }}</h3></caption>
    <tr class="table-light"> 
        <th>Дата</th>
        <th>День</th>
        <th>Самочувствие</th>
        <th>Масса</th>
        <th>Жирность</th>
        <th>Пульс</th>
        {% if show_pressure_period %}
            <th>Давление</th>
        {% endif%}
        <th>Калории</th>
        <th>Белки</th>
        <th>Жиры</th>
        <th>Углеводы</th>
    </tr>
    {% for day in period|dictsort:"date" %}
    <tr class="my-hover">
        <td>{{ day.date|date:"j b" }}</td>
        <td>{{ day.date|date:"D" }}</td>
        <td>{% if day.feel %}{{ day.feel }}/10{% endif %}</td>
        <td>{% if day.weight %}{{ day.weight }} кг{% endif %}</td>
        <td>{% if day.fat %}{{ day.fat }} %{% endif %}</td>
        <td>{{ day.pulse|default_if_none:"" }}</td>
        {% if show_pressure_period %}
            <td>{% if day.pressure_upper is not None and day.pressure_lower is not None %}
                    {{ day.pressure_upper }}/{{ day.pressure_lower }}
                {% endif %}</td>
        {% endif%}
        <td>{{ day.calories|default_if_none:"" }}</td>
        <td>{{ day.protein|default_if_none:"" }}</td>
        <td>{{ day.fats|default_if_none:"" }}</td>
        <td>{{ day.carbohydrates|default_if_none:"" }}</td>
    </tr>
    {% endfor %}
    <tr class="table-light">
        <th colspan="2">В среднем:</th>
        <th>{{ avg_period.avg_feel|default:"" }}</th>
        <th>{{ avg_period.avg_weight|default:"" }}</th>
        <th>{{ avg_period.avg_fat|default:"" }}</th>
        <th>{{ avg_period.avg_pulse|default:"" }}</th>
        {% if show_pressure_period %}
            <th>{{ avg_period.avg_pressure|default:"" }}</th>
        {% endif%}
        <th>{{ avg_period.avg_calories|default:"" }}</th>
        <th>{{ avg_period.avg_protein|default:"" }}</th>
        <th>{{ avg_period.avg_fats|default:"" }}</th>
        <th>{{ avg_period.avg_carbohydrates|default:"" }}</th>
    </tr>
</table><br>
{% endif %}

<!-- Выбор дней статистики -->
<form action="" method="get" class="period_select">
    <h5>Статистика за
    <input type="number" class="form-control text-center d-inline" name="selectperiod" min="1" id="input_period">
    дней</h5>
    <button type="submit" class="btn btn-primary d-inline" name="submit">Получить</button></h5>
</form>
<br><br>


<script src="{% static 'personalpage/js/personalpage.js' %}"></script>
{% endblock %}